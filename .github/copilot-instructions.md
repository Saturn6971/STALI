# Copilot Instructions for STALI

- **Stack & entrypoints**: Next.js App Router, heavy client components. Root layout (`src/app/layout.tsx`) wraps `AuthProvider` and `ComparisonProvider`; chat routes (`src/app/chat/layout.tsx`) wrap `ChatProvider`.
- **Dev commands**: `npm run dev` / `npm run build` (Turbopack) and `npm start`. No test runner configured.
- **Paths & styles**: `@/*` -> `src/*`. Tailwind v4 via `@import "tailwindcss"`; theme variables in `src/app/globals.css` (`--brand`, `--brand-light`, `--card-bg`, etc.) and Geist fonts loaded in `layout.tsx`.
- **Supabase client**: `src/lib/supabase.ts` creates a browser client; falls back to baked-in URL/anon key but prefer env (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`). Types exported from `src/types/index.ts`.
- **Auth pattern**: `src/lib/auth.tsx` manages session state with `supabase.auth.getSession` + `onAuthStateChange`, and ensures a `users` row exists after sign-up/sign-in. Use `useAuth` for `user`, `session`, `signIn`, `signUp`, `signOut`, `resetPassword`; keep UI under `AuthProvider` (already in root layout).
- **Chat pattern**: `src/lib/chat.tsx` keeps conversations/messages in context, fetches from Supabase with nested relations (`systems`, `cpu_listings`, `gpu_listings`, `users`, `messages`), adds realtime `messages` subscription, and auto-marks reads when `setCurrentConversation` is called. Prevents self-convos and refreshes `last_message`/`unread_count` after sends.
- **Data hooks**: `src/hooks/useCPUs.ts`, `useGPUs.ts`, `useSystems.ts` fetch active listings (`cpu_listings`, `gpu_listings`, `systems`) with joined model/manufacturer/seller data. Filter hooks (`useCPUFiltered`, `useGPUFiltered`) apply Supabase filters then client-side manufacturer filtering to compensate for nested filter limits; sorting controlled by `sortBy`.
- **Comparison state**: `src/hooks/useComparison.tsx` stores `cpuComparison` IDs in `localStorage` (max 4). Provided at root; call `addToComparison`/`removeFromComparison` and redirect to compare pages with `ids` query param.
- **Utilities**: `src/utils/index.ts` for `formatCurrency` (EUR, `en-EU`), `formatDate`, `getConditionColor`, `debounce`, savings helpers. `src/utils/gamingCompatibility.ts` holds heuristic compatibility/FPS estimates (`estimateSystemFps`, tier maps, `getCompatibilityColor/Label`).
- **Auth UI**: `src/components/auth/AuthForm.tsx` drives sign-in/up with password confirmation, optional username/display name, and `redirect` query support. Pages under `src/app/auth/*` defer render until auth state resolved.
- **Marketplace pages**: Listing pages (`src/app/cpus/page.tsx`, etc.) are client components that pair filter state with the hooks above, use `formatCurrency`, and lean on CSS variables for look. Keep new UI aligned with those patterns instead of introducing server components.
- **API routes**:
  - `/api/contact` (`src/app/api/contact/route.ts`) sends Brevo transactional email; requires `BREVO_API_KEY`, `BREVO_FROM_EMAIL`, `BREVO_FROM_NAME`, `CONTACT_TO_EMAIL`.
  - `/api/fps-estimate` (`src/app/api/fps-estimate/route.ts`) calls Google Generative Language API (Gemini). Needs `GEMINI_API_KEY`, optional `GEMINI_MODEL` (default `models/gemini-1.5-flash`); Node runtime; returns `{ fps }` integer, clamped to 2Ã— baseline.
  - `/api/account/delete` (`src/app/api/account/delete/route.ts`) accepts access token (body `accessToken` or `Authorization: Bearer`). Uses `SUPABASE_SERVICE_ROLE_KEY` to delete related rows (`systems`, `cpu_listings`, `gpu_listings`, `conversations`, `users`) then auth user. Requires public Supabase env vars too.
- **Env checklist**: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `BREVO_*`, `CONTACT_TO_EMAIL`, `GEMINI_API_KEY`, optional `GEMINI_MODEL`. Replace repo fallbacks with real secrets in production.
- **Pricing/formatting**: Prices shown in EUR; reuse `formatCurrency` and condition badges (`getConditionColor` or inline patterns) to stay consistent.
- **When extending**: Prefer existing hooks/contexts over ad hoc Supabase calls; keep chat pages inside `ChatProvider`; keep comparison logic within `ComparisonProvider`; preserve CSS var palette and Geist fonts for new components.
